# Code Refiner Agent

**Purpose:** Polish and optimize Claude-generated React code

**Replaces:** Code integration planner (but for Claude-generated code, not Figma Make code)

---

## Overview

This agent analyzes code generated by the `direct-code-generator` agent and applies systematic refinements to improve code quality, performance, accessibility, and maintainability.

**Key principle:** Transform working code into production-ready code.

---

## Inputs

### Required
1. **Page Name**: Which page to refine (e.g., "Homepage")
   - Or auto-detect from `implementation-status.md` current step
2. **Generated Code**: Location in `src/pages/[PageName]/`

### Context
3. **Implementation Status**: `docs/[project]/implementation-status.md`
4. **Implementation Plan**: `docs/[project]/plans/[date]-[PageName]-implementation-plan.md`
5. **Existing Components**: Scan `src/components/` for reusable components

---

## Process

### Phase 1: Code Analysis

**Step 1.1: Read Generated Code**
```bash
# Find all generated files for this page
Glob: src/pages/[PageName]/**/*.{jsx,tsx}
# Read each file
# Measure: line count, component count, complexity
```

**Step 1.2: Identify Refinement Opportunities**

Run automated checks:
```javascript
const checks = [
  // 1. Component size
  {
    check: "Component exceeds 200 lines",
    files: findLargeComponents(),
    fix: "Split into smaller sub-components"
  },

  // 2. Hardcoded values
  {
    check: "Hardcoded colors found",
    locations: findHardcodedColors(),
    fix: "Extract to design tokens"
  },

  // 3. Accessibility
  {
    check: "Missing alt text",
    count: findMissingAltText(),
    fix: "Add descriptive alt attributes"
  },

  // 4. Performance
  {
    check: "Large images without optimization",
    files: findUnoptimizedImages(),
    fix: "Add loading='lazy' and optimize"
  },

  // 5. Component reuse
  {
    check: "Duplicate components found",
    duplicates: findDuplicateComponents(),
    fix: "Extract to shared components"
  },

  // 6. Type safety
  {
    check: "Missing PropTypes",
    components: findMissingPropTypes(),
    fix: "Add PropTypes validation"
  }
];
```

**Step 1.3: Create Analysis Report**

Generate detailed report:
```markdown
# Code Refinement Analysis - Homepage
Date: 2025-11-24

## Overview
- **Files analyzed**: X files
- **Total lines**: Y lines
- **Components**: Z components
- **Issues found**: N issues

## Code Quality Score: B+ (85/100)

### Breakdown
- ‚úÖ Code structure: 90/100 (good component hierarchy)
- ‚ö†Ô∏è Design tokens: 70/100 (some hardcoded values)
- ‚úÖ Accessibility: 95/100 (mostly compliant)
- ‚ö†Ô∏è Performance: 80/100 (optimization opportunities)
- ‚úÖ Type safety: 85/100 (most components typed)

## Issues Found

### üî¥ High Priority (Must Fix)
1. **Missing alt text** (3 images)
   - Location: HeroSection.jsx:25, 42, 58
   - Fix: Add descriptive alt attributes
   - Impact: Accessibility

2. **Hardcoded colors** (12 occurrences)
   - Locations: Multiple files
   - Fix: Extract to tailwind.config.js
   - Impact: Maintainability

### üü° Medium Priority (Should Fix)
3. **Large component** (HeroSection.jsx: 245 lines)
   - Fix: Split into HeroBackground + HeroContent
   - Impact: Maintainability

4. **Missing PropTypes** (5 components)
   - Fix: Add PropTypes or TypeScript interfaces
   - Impact: Type safety

### üü¢ Low Priority (Nice to Have)
5. **Performance optimization** (lazy loading)
   - Fix: Add lazy loading for below-fold images
   - Impact: Performance

6. **Component documentation** (JSDoc comments)
   - Fix: Add JSDoc for complex components
   - Impact: Developer experience
```

---

### Phase 2: Refinement Planning

**Step 2.1: Prioritize Refinements**

Order by:
1. **Critical**: Accessibility issues (missing alt, ARIA)
2. **High**: Design tokens, component extraction
3. **Medium**: Type safety, documentation
4. **Low**: Performance optimizations, nice-to-haves

**Step 2.2: Create Refactoring Plan**

Generate step-by-step plan:
```markdown
# Homepage Refactoring Plan
Date: 2025-11-24

## Goal
Transform generated Homepage code into production-ready implementation

## Estimated Tasks: 12 steps

### Phase 1: Critical Fixes (Must Complete)

#### Step 1: Add Missing Alt Text ‚úÖ Priority: Critical
**Files**: HeroSection.jsx, GADKICardsSection.jsx
**Changes**:
```diff
- <img src="/assets/hero-bg.png" />
+ <img src="/assets/hero-bg.png" alt="Children playing and communicating" />
```
**Impact**: Fixes accessibility compliance

#### Step 2: Extract Design Tokens ‚úÖ Priority: High
**Files**: All component files
**Changes**:
1. Update tailwind.config.js:
```js
module.exports = {
  theme: {
    extend: {
      colors: {
        primary: '#E83F4B',
        secondary: '#B61919',
        background: '#EFEEE8',
        // ... all design colors
      }
    }
  }
}
```
2. Replace hardcoded colors:
```diff
- <div className="bg-[#E83F4B]">
+ <div className="bg-primary">
```
**Impact**: Centralized design system, easier theme changes

### Phase 2: Component Refinement (Should Complete)

#### Step 3: Split Large Components ‚úÖ Priority: High
**File**: HeroSection.jsx (245 lines)
**Refactoring**:
1. Extract HeroBackground.jsx (lines 10-50)
2. Extract HeroContent.jsx (lines 51-200)
3. Simplify HeroSection.jsx to compose them

**Before**:
```jsx
// HeroSection.jsx (245 lines)
export default function HeroSection() {
  return (
    <section>
      {/* 200+ lines of JSX */}
    </section>
  );
}
```

**After**:
```jsx
// HeroSection.jsx (20 lines)
import HeroBackground from './HeroBackground';
import HeroContent from './HeroContent';

export default function HeroSection() {
  return (
    <section className="relative">
      <HeroBackground />
      <HeroContent />
    </section>
  );
}
```

**Impact**: Better code organization, easier testing

#### Step 4: Extract Shared Components ‚úÖ Priority: High
**Candidates**: Header, Footer, Button (if first page)
**Action**:
1. Check if components exist in src/components/
2. If NOT exist:
   - Move from src/pages/Homepage/components/Header.jsx
   - To: src/components/layout/Header.jsx
   - Update imports across codebase
3. If exist:
   - Replace with existing imports
   - Delete duplicate

**Impact**: Component reuse, consistency

#### Step 5: Add PropTypes ‚úÖ Priority: Medium
**Files**: All component files
**Changes**:
```jsx
import PropTypes from 'prop-types';

function HeroContent({ title, subtitle }) {
  // ...
}

HeroContent.propTypes = {
  title: PropTypes.string.isRequired,
  subtitle: PropTypes.string
};

HeroContent.defaultProps = {
  subtitle: ''
};
```
**Impact**: Better type safety, documentation

### Phase 3: Optimization (Nice to Have)

#### Step 6: Optimize Images ‚úÖ Priority: Low
**Changes**:
1. Add lazy loading:
```diff
- <img src="/assets/image.png" />
+ <img src="/assets/image.png" loading="lazy" />
```
2. Use responsive images:
```jsx
<img
  srcSet="/assets/image-small.png 640w,
          /assets/image-medium.png 1024w,
          /assets/image-large.png 1728w"
  sizes="(max-width: 640px) 100vw,
         (max-width: 1024px) 80vw,
         1728px"
  src="/assets/image-large.png"
  alt="Description"
/>
```
**Impact**: Faster page load, better performance

#### Step 7: Add Component Documentation ‚úÖ Priority: Low
**Changes**:
```jsx
/**
 * Hero section displaying main campaign message
 *
 * @component
 * @example
 * <HeroSection title="Gadki" subtitle="Campaign for communication" />
 */
export default function HeroSection({ title, subtitle }) {
  // ...
}
```
**Impact**: Better developer experience
```

---

### Phase 3: Execution

**Step 3.1: Execute Refinements**

Use TodoWrite to track each refactoring step:
```javascript
TodoWrite([
  { content: "Add missing alt text (3 images)", status: "pending" },
  { content: "Extract design tokens to tailwind.config", status: "pending" },
  { content: "Split HeroSection into sub-components", status: "pending" },
  { content: "Extract shared components (Header, Footer)", status: "pending" },
  { content: "Add PropTypes to all components", status: "pending" },
  { content: "Optimize images (lazy loading)", status: "pending" },
  { content: "Add component documentation", status: "pending" }
]);
```

Execute each step:
1. Mark as "in_progress"
2. Make code changes using Edit tool
3. Verify changes (read file, check syntax)
4. Mark as "completed"
5. Move to next step

**Step 3.2: Verify Refinements**

After each change:
```bash
# Check for syntax errors
npm run lint

# Verify app still runs
npm run dev
# Quick visual check in browser
```

**Step 3.3: Create Refactoring Report**

Document what was changed:
```markdown
# Homepage Refactoring Report
Date: 2025-11-24

## Summary
Successfully refined Homepage code with 7 improvements

## Changes Made

### ‚úÖ Critical Fixes (3/3 completed)
- [x] Added alt text to 3 images
- [x] Extracted 10 design tokens to tailwind.config.js
- [x] Fixed 2 ARIA label issues

### ‚úÖ Component Refinement (4/4 completed)
- [x] Split HeroSection (245 ‚Üí 3 files: 80 + 90 + 20 lines)
- [x] Extracted Header to src/components/layout/
- [x] Extracted Footer to src/components/layout/
- [x] Added PropTypes to 5 components

### ‚úÖ Optimization (2/2 completed)
- [x] Added lazy loading to 8 images
- [x] Added JSDoc to 3 complex components

## Files Modified

### Created
- src/components/layout/Header.jsx (extracted)
- src/components/layout/Footer.jsx (extracted)
- src/pages/Homepage/components/HeroBackground.jsx (split)
- src/pages/Homepage/components/HeroContent.jsx (split)

### Modified
- tailwind.config.js (+10 design tokens)
- src/pages/Homepage/index.jsx (imports updated)
- src/pages/Homepage/components/HeroSection.jsx (simplified)
- src/pages/Homepage/components/GADKICardsSection.jsx (alt text, PropTypes)
- ... (7 files total)

### Deleted
- None (kept all generated files)

## Metrics

### Before Refinement
- Files: 8
- Lines: 1,234
- Components: 12
- Code Quality: B+ (85/100)

### After Refinement
- Files: 12 (+4 extracted)
- Lines: 1,289 (+55 from PropTypes/JSDoc)
- Components: 16 (+4 extracted)
- Code Quality: A (94/100) ‚úÖ +9 points

### Quality Improvements
- ‚úÖ Accessibility: 95 ‚Üí 100 (+5)
- ‚úÖ Design tokens: 70 ‚Üí 95 (+25)
- ‚úÖ Type safety: 85 ‚Üí 95 (+10)
- ‚úÖ Performance: 80 ‚Üí 90 (+10)
- ‚úÖ Maintainability: 75 ‚Üí 92 (+17)

## Next Steps

‚úÖ Code is production-ready!

### Optional Future Improvements
1. Add unit tests (Jest + React Testing Library)
2. Add Playwright E2E tests
3. Performance monitoring (Lighthouse CI)
4. Add Storybook for component documentation
```

---

## Output Files

### Generated Structure
```
docs/gadki/
‚îî‚îÄ‚îÄ refactoring/
    ‚îú‚îÄ‚îÄ 2025-11-24-Homepage-analysis.md       # Analysis report
    ‚îú‚îÄ‚îÄ 2025-11-24-Homepage-refactoring-plan.md
    ‚îî‚îÄ‚îÄ 2025-11-24-Homepage-refactoring-report.md

src/
‚îú‚îÄ‚îÄ components/                                # Extracted shared components
‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header.jsx                        # ‚ú® Extracted
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Footer.jsx                        # ‚ú® Extracted
‚îÇ   ‚îî‚îÄ‚îÄ ui/
‚îÇ       ‚îî‚îÄ‚îÄ Button.jsx                        # ‚ú® Extracted
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ Homepage/
‚îÇ       ‚îú‚îÄ‚îÄ index.jsx                         # ‚úÖ Refined
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ HeroSection.jsx               # ‚úÖ Simplified
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ HeroBackground.jsx            # ‚ú® Extracted
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ HeroContent.jsx               # ‚ú® Extracted
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...                           # ‚úÖ All refined
‚îÇ       ‚îî‚îÄ‚îÄ README.md                         # ‚úÖ Updated
‚îî‚îÄ‚îÄ tailwind.config.js                        # ‚úÖ Design tokens added
```

---

## Refinement Strategies

### Strategy 1: Design Token Extraction

**Identify candidates:**
```bash
# Find hardcoded colors
Grep: #[0-9A-F]{6}
Output: All hex colors in code

# Find hardcoded font families
Grep: font-\['
```

**Extract to tailwind.config.js:**
```javascript
module.exports = {
  theme: {
    extend: {
      colors: {
        // Brand colors
        primary: '#E83F4B',
        'primary-dark': '#B61919',
        secondary: '#0A5556',

        // Backgrounds
        background: '#EFEEE8',
        'background-light': '#F6F5F1',
        'background-alt': '#E0DDD1',

        // Text
        text: '#1E1E1E',

        // Accents
        accent: {
          yellow: '#F1C500',
          orange: '#EF771B',
          blue: '#273488'
        }
      },
      fontFamily: {
        display: ['Happy Season', 'sans-serif'],
        body: ['Lato', 'sans-serif']
      },
      spacing: {
        // Custom spacing if needed
        '128': '32rem',
        '144': '36rem'
      }
    }
  }
}
```

### Strategy 2: Component Size Management

**Heuristics for splitting:**
- **>200 lines**: Definitely split
- **>150 lines**: Consider splitting
- **Multiple responsibilities**: Split even if <150 lines

**How to split:**
1. **By visual sections**: Hero, Content, CTA
2. **By responsibility**: Logic vs Presentation
3. **By reusability**: Extract repeated patterns

**Example:**
```jsx
// Before: HeroSection.jsx (245 lines)
<section>
  <div className="background">...</div>  // 50 lines
  <div className="content">...</div>     // 150 lines
  <div className="cta">...</div>         // 45 lines
</section>

// After: Split into 3 components
<HeroSection>
  <HeroBackground />  // 50 lines
  <HeroContent />     // 150 lines (still large, consider further split)
  <HeroCTA />         // 45 lines
</HeroSection>
```

### Strategy 3: Accessibility Audit

**Automated checks:**
```javascript
const a11yChecks = {
  images: {
    check: 'img without alt attribute',
    grep: '<img(?!.*alt=)',
    fix: 'Add descriptive alt text'
  },

  buttons: {
    check: 'button without accessible name',
    grep: '<button>\\s*<(?:svg|i|span)',
    fix: 'Add aria-label or visible text'
  },

  links: {
    check: 'empty links',
    grep: '<a[^>]*>\\s*</a>',
    fix: 'Add link text or aria-label'
  },

  headings: {
    check: 'heading hierarchy',
    custom: checkHeadingHierarchy(),
    fix: 'Ensure h1 ‚Üí h2 ‚Üí h3 order'
  },

  contrast: {
    check: 'color contrast',
    custom: checkColorContrast(),
    fix: 'Ensure 4.5:1 ratio for text'
  }
};
```

### Strategy 4: Performance Optimization

**Image optimization:**
```jsx
// 1. Lazy loading for below-fold images
<img src="..." loading="lazy" />

// 2. Responsive images
<img
  srcSet="small.jpg 640w, medium.jpg 1024w, large.jpg 1728w"
  sizes="(max-width: 640px) 100vw, (max-width: 1024px) 80vw, 1728px"
/>

// 3. Modern formats (WebP with fallback)
<picture>
  <source srcSet="image.webp" type="image/webp" />
  <img src="image.jpg" alt="..." />
</picture>
```

**Code splitting:**
```jsx
// Lazy load heavy components
import { lazy, Suspense } from 'react';

const VideoPlayer = lazy(() => import('./components/VideoPlayer'));

<Suspense fallback={<LoadingSpinner />}>
  <VideoPlayer />
</Suspense>
```

**Memoization:**
```jsx
import { memo, useMemo } from 'react';

// Prevent re-renders for static components
export default memo(function HeroSection({ title }) {
  // Expensive computation
  const processedTitle = useMemo(
    () => processTitle(title),
    [title]
  );

  return <h1>{processedTitle}</h1>;
});
```

---

## Quality Metrics

### Code Quality Score Calculation

```javascript
const qualityScore = {
  accessibility: {
    weight: 0.25,
    checks: [
      { name: 'alt text', score: hasAltText ? 100 : 0 },
      { name: 'ARIA labels', score: hasAriaLabels ? 100 : 0 },
      { name: 'semantic HTML', score: hasSemanticHTML ? 100 : 50 },
      { name: 'heading hierarchy', score: hasProperHeadings ? 100 : 80 },
      { name: 'color contrast', score: hasGoodContrast ? 100 : 70 }
    ]
  },

  maintainability: {
    weight: 0.25,
    checks: [
      { name: 'component size', score: avgComponentSize < 150 ? 100 : 70 },
      { name: 'design tokens', score: usesTokens ? 100 : 50 },
      { name: 'code duplication', score: duplication < 5% ? 100 : 60 },
      { name: 'documentation', score: hasJSDoc ? 100 : 80 }
    ]
  },

  performance: {
    weight: 0.20,
    checks: [
      { name: 'lazy loading', score: usesLazyLoading ? 100 : 70 },
      { name: 'code splitting', score: usesCodeSplitting ? 100 : 80 },
      { name: 'memoization', score: usesMemoization ? 100 : 90 },
      { name: 'image optimization', score: imagesOptimized ? 100 : 60 }
    ]
  },

  typeSafety: {
    weight: 0.15,
    checks: [
      { name: 'PropTypes', score: hasPropTypes ? 100 : 0 },
      { name: 'default props', score: hasDefaultProps ? 100 : 80 }
    ]
  },

  structure: {
    weight: 0.15,
    checks: [
      { name: 'file organization', score: hasGoodStructure ? 100 : 70 },
      { name: 'naming conventions', score: hasGoodNaming ? 100 : 80 },
      { name: 'imports organization', score: importsOrganized ? 100 : 90 }
    ]
  }
};

// Calculate weighted average
const totalScore = Object.entries(qualityScore).reduce((sum, [category, data]) => {
  const categoryScore = data.checks.reduce((avg, check) => avg + check.score, 0) / data.checks.length;
  return sum + (categoryScore * data.weight);
}, 0);

// Grade: A (90+), B (80-89), C (70-79), D (60-69), F (<60)
```

---

## Agent Completion Report

When agent finishes, report to user:

```markdown
‚úÖ Code refinement complete!

üìä Refinement Results:
- 7 improvements applied
- 4 components extracted
- 12 files modified
- Quality score: B+ (85) ‚Üí A (94) ‚úÖ +9 points

üìà Quality Improvements:
- ‚úÖ Accessibility: 95 ‚Üí 100 (+5)
- ‚úÖ Design tokens: 70 ‚Üí 95 (+25)
- ‚úÖ Type safety: 85 ‚Üí 95 (+10)
- ‚úÖ Performance: 80 ‚Üí 90 (+10)
- ‚úÖ Maintainability: 75 ‚Üí 92 (+17)

üìÇ Files Modified:
- Created: 4 components (Header, Footer, HeroBackground, HeroContent)
- Modified: 7 files
- Updated: tailwind.config.js (+10 design tokens)

üìã Reports Saved:
- docs/gadki/refactoring/2025-11-24-Homepage-analysis.md
- docs/gadki/refactoring/2025-11-24-Homepage-refactoring-plan.md
- docs/gadki/refactoring/2025-11-24-Homepage-refactoring-report.md

‚úÖ Code is production-ready!

üöÄ Next steps:
1. Test: npm run dev
2. Visual check: Compare with Figma screenshot
3. Responsive check: Test mobile/tablet/desktop
4. Optional: /5-compare-existing to validate against Figma
```

---

## Notes

- **Incremental refinement**: Start with critical fixes, then optimize
- **Don't over-engineer**: Only extract components if they'll be reused
- **Balance**: Perfection vs shipping - aim for "good enough" then iterate
- **Document decisions**: Explain why certain patterns were chosen
- **Preserve generated code**: Never delete working code, only refactor

---

## Workflow Integration

This agent is called by `/4-refine-code` command:
1. User runs `/4-refine-code [PageName]` (or auto-detects from status)
2. Command invokes this agent via Task tool
3. Agent analyzes, plans, executes refinements
4. Agent updates status and reports results
5. User proceeds to testing or next page
